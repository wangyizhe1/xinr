<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>index</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <script src="jquery-3.4.1/jquery-3.4.1.js"></script>
    <script src="bootstrap-3.3.7-dist/js/bootstrap.js"></script>
    <link rel="stylesheet" href="bootstrap-3.3.7-dist/css/bootstrap.css">
    <link rel="stylesheet" href="css/Index.css">
    <style>
        .dropdown-menu {
            position: absolute;
            top: 37px;
            padding-bottom: 0px;
            left: 54%;
            width: 50% !important;
        }


        .dropdown-menu .divider {
            height: 1px;
            margin: 6px 0;
            overflow: hidden;
            margin-left: 14px;
            width: 80%;
            background-color: #e5e5e5;
            border: none;
        }

        .dropdown-menu:after {

            content: ' ';

            height: 0;

            position: absolute;

            width: 0;

            border: 10px solid transparent;

            border-bottom-color: #ffffff;
            margin-top: -103px;
            left: 74%;

        }

        .dropdown-menu > li > div {
            display: block;
            padding: 3px 20px;
            clear: both;
            font-weight: normal;
            line-height: 1.42857143;
            color: #333;
            white-space: nowrap;
        }

        /*#czmm{*/
        /*width: 100%;*/
        /*height: 310px;*/
        /*top: 0px;*/

        /*}*/
        .dropdown-backdrop {
            background: #3c3b3b;
            opacity: 0.3;
        }

        .sz {
            margin: 0;
            padding: 0;
            border: none;
        / / 自定义边框 outline: none;
        / / 消除默认点击蓝色边框效果
        }


    </style>
</head>
<body>
<div class="container">
    <div class="row">
        <div style="display:none;top: 400px;" class="cw col-xs-12">
            <div class="cw1" style="width: 171px;">登录时间过长,请重新登录</div>
        </div>
        <div class=" xq">
            <div class="nl">
                <div class="bd">
                    <div class="dropdown">


                        <button type="button" class="sz" data-toggle="dropdown">
                        </button>
                        <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu" style="min-width: 0px;">
                            <li>
                                <div tabindex="-1" href="#" id="ggmm">更改密码
                                </div>
                            </li>
                            <li class="divider"></li>
                            <li>
                                <div tabindex="-1" href="#" id="tc">退出</div>
                            </li>
                            <li class="divider"></li>
                        </ul>
                    </div>
                    <div class="bd1">
                        <span>昵称 :</span>
                        <span class="bd2" id="username">张三</span>
                    </div>
                    <div class="bd1" style="padding-top: 0px">
                        <span>手机号 :</span>
                        <span class="bd2" id="phone">18833009944</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="qp" style="display: none"></div>

        <div class="cw3 "  style="display: none">
            <div class="cw4">
                <div class="row">
                    <div class="form-horizontal" id="register_form" method="post">
                        <div style="display: none;" class="cw col-xs-12">
                            <div class="cw1">请输入</div>
                        </div>
                        <div class="zc col-xs-12" style="height: 33px;">
                            <div class="cd">

                            </div>
                        </div>
                        <div class="zc col-xs-12" >
                            <spen>重置密码</spen>
                        </div>
                        <div class="form-group">
                            <div class="col-xs-12">
                                <input type="text" id="staff_tel" class="form-control input_bar" name="staff_tel"
                                       placeholder="手机号">
                                <span class="glyphicon glyphicon-sj form-control-feedback" aria-hidden="true"></span>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-xs-12">
                                <input type="text" class="form-control input_bar" id="sms_code" name="sms_code"
                                       placeholder="验证码">
                                <span class="glyphicon glyphicon-yz form-control-feedback" aria-hidden="true"></span>
                                <span class="glyphicon glyphicon-hq form-control-feedback" aria-hidden="true"
                                      onclick="sendemail()" id="verifyCodeBtn">
                        获取验证码</span>
                            </div>
                        </div>
                        <div class="form-group" style="padding-bottom: 11px">
                            <div class="col-xs-12">
                                <input type="password" class="form-control input_bar" id="password" name="password"
                                       placeholder="登录密码">
                                <span class="glyphicon glyphicon-dl form-control-feedback" aria-hidden="true"></span>
                            </div>
                        </div>
                        <div class="zc col-xs-12">
                            <spen style="color: #999999;font-size: 16px;font-weight: 300; ">(6-16位字母和数字的结合)</spen>
                        </div>
                        <div class="form-group" style="padding-top: 50px;padding-bottom: 0px">
                            <div class="col-xs-12">
                                <button type="submit" id="submit_btn" class="btn btn-default">完成</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class=" col-xs-12 qb">
            <div class="col-xs-6 qb1">
                <div class="hd yb1">
                </div>
                <div class="hd1">
                    <div>活动列表</div>
                </div>
            </div>
            <div class="col-xs-6 qb2">
                <div class="hd yb"></div>
                <div class="hd2">
                    <div>客户列表</div>
                </div>

            </div>
        </div>


        <!--<div style="display: block;" id="czmm" class="cw col-xs-12">-->
        <!--<div class="cw1">请输入</div>-->
        <!--</div>-->
    </div>
</div>
<script>
    $.ajax({
        type: "get",
        url: 'http://47.99.106.241:3000/mock/164/mobile/staff/get_staff_info',
        data: [],
        dataType: "json", //ajax返回值设置为text(json格式也可用它返回，可打印出结果，也可设置成json)
        success: function (data) {
            $("#username").html(data.data.nickname);
            $("#phone").html(data.data.staff_tel)
            if (data.error == 77) {

                $('.cw').css("display", "block");
                $('.cw1').html("登录时间过长,请重新登录");
                setTimeout(function () {
                    window.location.href = "Sign in.html";
                }, 1000);
            }
        },
        error: function (json) {
            toastr.error('返回数值出错!');
        }
    });
    $("#ggmm").on('click', function () {
        $(".qp").css("display","block");
        $(".cw3").css("display","block");

    })
    $(".cd").on('click', function () {
        $(".qp").css("display","none");
        $(".cw3").css("display","none");
        $(".cw").css("display","none");

    })
    $("#tc").on('click', function () {
        $.ajax({
            type : "get",
            url : 'http://47.99.106.241:3000/mock/164/mobile/staff/login_out',
            data: [],
            dataType : "json",
            success : function(data) {
                if(data.error == 0){
                    window.location.href="Sign in.html";

                }
            },
            error : function(json) {
                toastr.error('返回数值出错!');
            }
        });


    })
    $(".yb1").on('click', function () {
        window.location.href="List.html";
    })
    $(".yb").on('click', function () {
        window.location.href="Customer.html";
    })
</script>
<script type="text/javascript">
    var phone=false; //判定手机符合格式
    var sms_code = ""; //接收验证码
    var password = /^[a-zA-Z0-9_-]{6,16}$/; //密码
    var sms_code = /^[a-zA-Z0-9_-]{6,16}$/;
    var tel = /^(13[0-9]|14[5|7]|15[0|1|2|3|5|6|7|8|9]|17[0,6,7,8]|18[0|1|2|3|5|6|7|8|9])\d{8}$/;
    var isStaff_tel;
    var isSms_code;
    var isPassword;
    var phone=false;
    // 如果输入框为空阻止提交
    if ($('input', '#register_form').val() == '') {
        isStaff_tel= false;
        isSms_code= false;
        isPassword= false;
    }

    // 输入框焦点事件
    $('#register_form').on({
        focus: function () {
            // 获取焦点

        },
        blur: function () {
            // 失去焦点，通过id判断
            switch ($(this).attr('id')) {
                case 'staff_tel':
                    if (!tel.test($(this).val())) {
                        isStaff_tel = false;
                        $('.cw').css("display", "block");
                        $('.cw1').html("手机格式不正确");
                    } else {
                        isStaff_tel = true;
                        $('.cw').css("display", "none");
                        phone=true;
                        console.log(phone);
                    }
                    break;
                case 'sms_code':
                    if (!sms_code.test($(this).val())) {
                        isSms_code = false;
                        $('.cw').css("display", "block");
                        $('.cw1').html("验证码格式不正确");
                    } else {
                        isSms_code = true;
                        $('.cw').css("display", "none");
                    }
                    break;
                case 'password':
                    if (!password.test($(this).val())) {
                        isPassword = false;
                        $('.cw').css("display", "block");
                        $('.cw1').html("密码格式不正确");

                    } else {
                        isPassword = true;
                        $('.cw').css("display", "none");
                    }
                    break;
                default:
                    break;
            }
        }
    }, '.input_bar');

    var countdown=60;
    function sendemail(){

        if(phone==true){
            $("#verifyCodeBtn").css("pointer-events", "none");
            var obj = $("#verifyCodeBtn");
            var tel=$("#staff_tel").val();
            console.log(tel)
            settime(obj);
            $.ajax({
                url: "http://47.99.106.241:3000/mock/164/common/api/send_sms_code",
                type: "post",
                data: {tel: tel},
                success: function (data) {
                    console.log(data)

                }, error: function () {
                    alert("发送未知错误！ 无法发送验证码！")
                }
            });
            function settime(obj) { //发送验证码倒计时
                if (countdown == 0) {
                    obj.attr('disabled',false);
                    //obj.removeattr("disabled");
                    obj.html("获取验证码");
                    countdown = 60;
                    $("#verifyCodeBtn").css("pointer-events", "inherit");
                    return;
                } else {
                    obj.attr('disabled',true);
                    obj.html("重新发送(" + countdown + ")");
                    countdown--;
                }
                setTimeout(function() {
                        settime(obj) }
                    ,1000)
            }
        }else {
            $('.cw').css("display", "block");
            $('.cw1').html("请填写正确手机号");
            setTimeout(function(){$('.cw').css("display","none");},1000);
        }
    }
    $('#submit_btn').on('click', function () {
        if (isStaff_tel ==false ) {
            $('.cw').css("display","block");
            $('.cw1').html("手机格式不正确");
            setTimeout(function(){$('.cw').css("display","none");},1000);
            return false;
        } else if (isSms_code ==false) {
            $('.cw').css("display","block");
            $('.cw1').html("验证码格式不正确");
            setTimeout(function(){$('.cw').css("display","none");},1000);
            return false;
        }else if (isPassword ==false) {
            $('.cw').css("display","block");
            $('.cw1').html("密码格式不正确");
            setTimeout(function(){$('.cw').css("display","none");},1000);
            return false;
        }

        $.ajax({
            type : "post",
            url : 'http://47.99.106.241:3000/mock/164/mobile/staff/reset_password',
            data: "&staff_tel=" + staff_tel + "&sms_code=" + sms_code + "&password=" + password,
            dataType : "json",
            success : function(data) {
                if(data.error == 0){
                    $('.cw').css("display","block");
                    $('.cw1').html("修改成功");
                    setTimeout(function(){$('.cw').css("display","none");　window.location.href="Index.html";},1000);
                }else if(data.error == 1){
                    $('.cw').css("display","block");
                    $('.cw1').html("修改错误");
                    setTimeout(function(){$('.cw').css("display","none");},1000);
                }else if(data.error == 77){
                    $('.cw').css("display","block");
                    $('.cw1').html("登录时间过长,请重新登录");
                    setTimeout(function(){$('.cw').css("display","none");　window.location.href="Sign in.html";},1000);
                }
            },
            error : function(json) {
                toastr.error('返回数值出错!');
            }
        });
    })

</script>
</body>
</html>